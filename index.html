<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karunamaayi</title>
  <style>
    :root {
      --bg: #edf2ff;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-soft: #64748b;
      --accent: #3b82f6;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --border-soft: #e2e8f0;
    }
    [data-theme="dark"] {
      --bg: #020617;
      --card-bg: #020617;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --accent: #22c55e;
      --accent-soft: #064e3b;
      --accent-strong: #16a34a;
      --border-soft: #1f2933;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #dbeafe, #edf2ff);
      color: var(--text);
      margin: 0;
      padding: 0;
    }
    h1,h2,h3 { margin: 0; }
    .app-shell {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bfdbfe, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #eff6ff;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 10px 25px rgba(15,23,42,0.35);
    }
    .brand-text h1 {
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }
    .brand-text .subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
    }
    .chip-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--accent-strong);
    }
    .theme-select {
      font-size: 0.8rem;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #fff;
    }
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.08),
        0 0 0 1px rgba(148,163,184,0.12);
      margin-bottom: 16px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 20px 45px rgba(15,23,42,0.12),
        0 0 0 1px rgba(129,140,248,0.2);
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-soft);
    }
    .muted { font-size: 0.8rem; color: var(--text-soft); }
    .pill-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .pill-nav button {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 12px;
      font-size: 0.82rem;
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
    }
    .pill-nav button.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: var(--accent);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .row > * { flex: 1 1 220px; }
    label {
      font-size: 0.82rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: var(--text-soft);
    }
    input,select,textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.9);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }
    input:focus,select:focus,textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.25);
      background: #ffffff;
    }
    textarea { resize: vertical; min-height: 60px; }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent);
      color: white;
      box-shadow: 0 10px 20px rgba(37,99,235,0.3);
    }
    button.secondary {
      background: var(--accent-soft);
      color: var(--accent-strong);
      box-shadow: none;
      border: 1px solid rgba(148,163,184,0.3);
    }
    button:disabled { opacity: 0.4; cursor: default; box-shadow: none; }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--accent-strong);
      gap: 4px;
    }
    .entries-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .entry {
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: rgba(148,163,184,0.08);
      font-size: 0.82rem;
      border: 1px solid rgba(148,163,184,0.14);
    }
    .entry.small-padding { padding: 6px 8px; }
    .entry.clickable {
      cursor: pointer;
      transition: background 0.12s ease, transform 0.08s ease;
    }
    .entry.clickable:hover {
      background: rgba(129,140,248,0.12);
      transform: translateY(-1px);
    }
    .entry small { display: block; opacity: 0.7; }
    .streak {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }
    .streak strong { font-size: 1.1rem; }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px dashed #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
    }
    canvas { width: 100%; max-height: 220px; }
    iframe { background: #020617; border-radius: 12px; border: none; }

    /* Subject overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 12px;
    }
    .overlay-card {
      max-width: 1000px;
      width: 100%;
      max-height: 95vh;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .overlay-body {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      height: 100%;
    }
    .overlay-body > * { flex: 1 1 260px; min-height: 200px; }
    .overlay .entries-list { max-height: none; height: 100%; }
    .overlay iframe { width: 100%; height: 100%; }

    @media (max-width: 640px) {
      .top-bar { align-items: flex-start; }
      .brand-text h1 { font-size: 1.25rem; }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell">
    <!-- Header -->
    <div class="top-bar">
      <div class="brand-block">
        <div class="brand-logo">K</div>
        <div class="brand-text">
          <h1>Karunamaayi</h1>
          <div class="subtitle">UPSC ‚Ä¢ Career ‚Ä¢ Exams ‚Ä¢ Personal ‚Ä¢ Meditation</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span class="chip-pill">v<span id="versionLabel">1.3.0</span></span>
        <select id="themeSelect" class="theme-select">
          <option value="light">üåû Light</option>
          <option value="dark">üåô Dark</option>
        </select>
      </div>
    </div>

    <!-- Menu bar -->
    <div class="card">
      <div class="section-title">
        Menu
        <span class="muted">Choose area or admin</span>
      </div>
      <div class="pill-nav" id="mainNav">
        <button data-nav="home" class="active">üè† Home</button>
        <button data-nav="UPSC">UPSC</button>
        <button data-nav="Career">Career</button>
        <button data-nav="Other Exams">Other Exams</button>
        <button data-nav="Personal Work">Personal</button>
        <button data-nav="Meditation">Meditation</button>
        <button data-nav="tests">Weekly Tests</button>
        <button data-nav="admin">Admin</button>
      </div>
    </div>

    <!-- HOME PAGE -->
    <div id="page-home">
      <div class="card">
        <div class="section-title">
          AI Helper (offline, simple)
          <span class="muted">Use this on landing page anytime</span>
        </div>
        <label for="aiQuestion">Ask for help</label>
        <textarea id="aiQuestion" placeholder="Eg: How should I study history when my memory is weak?"></textarea>
        <div class="row" style="margin-top:6px;">
          <button class="secondary" id="aiBtn">‚ú® Get Tip</button>
          <button class="secondary" id="aiReadBtn">üîä Read Answer</button>
        </div>
        <div id="aiResponse" class="entry" style="margin-top:6px;"></div>
        <div class="muted" style="margin-top:4px;">
          This AI is rule-based inside the app. For deeper analysis, you can still ask ChatGPT.
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          Meditation (Om)
          <span class="muted">Use your favourite Om link (Art of Living, Sadhguru, etc.)</span>
        </div>
        <label for="omLink">Om audio / video link (YouTube)</label>
        <input id="omLink" placeholder="Paste Om chanting YouTube link here" />
        <div class="row" style="margin-top:8px;">
          <button class="secondary" id="om5Btn">üïâ Play Om ‚Äì 5 min</button>
          <button class="secondary" id="om10Btn">üïâ Play Om ‚Äì 10 min</button>
          <button class="secondary" id="omStopBtn">‚èπ Stop</button>
        </div>
        <div class="muted" id="omStatus" style="margin-top:6px;">Not playing.</div>
        <div style="margin-top:10px;">
          <iframe id="omFrame"
                  style="width:100%; aspect-ratio:16/9;"
                  src="">
          </iframe>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          Today‚Äôs Entry ‚Äì <span id="homePartLabel">UPSC</span>
          <span class="badge" id="todayBadge">Today</span>
        </div>
        <div class="row">
          <div>
            <label for="subjectSelect">Subject / Topic</label>
            <select id="subjectSelect"></select>
          </div>
          <div>
            <label for="timeInput">Time Studied (mins)</label>
            <input id="timeInput" type="number" min="0" />
          </div>
          <div>
            <label for="memoryInput">Memory (1‚Äì5)</label>
            <select id="memoryInput">
              <option value="1">1 ‚Äì Very low</option>
              <option value="2">2</option>
              <option value="3" selected>3 ‚Äì Okay</option>
              <option value="4">4</option>
              <option value="5">5 ‚Äì Strong</option>
            </select>
          </div>
        </div>
        <label for="learningInput" style="margin-top:10px;">What did you learn?</label>
        <textarea id="learningInput" placeholder="Example: Polity ‚Äì Fundamental Rights basics‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px; align-items:flex-end;">
          <div>
            <label for="reminderTime">Reminder (optional for this part)</label>
            <input id="reminderTime" type="time" />
            <div class="muted">We‚Äôll remind you if the app is open around this time.</div>
          </div>
          <div style="flex:0 0 160px;">
            <button id="saveEntryBtn">üíæ Save Entry</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="section-title">Streak & Progress ‚Äì <span id="homePartLabel2">UPSC</span></div>
            <div class="streak">
              <div>
                üî• Current: <strong id="currentStreak">0</strong> days<br/>
                üèÜ Best: <strong id="bestStreak">0</strong> days
              </div>
            </div>
            <button class="secondary" style="margin-top:8px;" id="reviveBtn">ü©π Revive streak (1√ó/week)</button>
            <div class="muted" style="margin-top:4px;">Revive lets you fix one missed day per week for motivation.</div>
          </div>
          <div>
            <div class="section-title">Last 7 days study (mins)</div>
            <canvas id="progressChart"></canvas>
            <div class="section-title" style="margin-top:10px;">Subject-wise time (current part)</div>
            <canvas id="subjectChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Entries ‚Äì <span id="entriesLabel">UPSC</span></div>
        <div class="entries-list" id="entriesList"></div>
      </div>
    </div>

    <!-- PART PAGE: shows only subjects list -->
    <div id="page-part" style="display:none;">
      <div class="card">
        <div class="section-title">
          <span id="partTitle">UPSC workspace</span>
          <button class="secondary" id="backToHomeBtn">‚Üê Back to Home</button>
        </div>
        <div class="muted" id="partSubtitle">
          Choose a subject to open its full-screen resources.
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          Subjects in this part
          <span class="muted">Tap a subject to open resources</span>
        </div>
        <div class="chip-row" id="partSubjectsList"></div>
      </div>
    </div>

    <!-- WEEKLY TESTS PAGE -->
    <div id="page-tests" style="display:none;">
      <div class="card">
        <div class="section-title">
          Weekly Tests & Assessment
          <button class="secondary" id="backTestsHomeBtn">‚Üê Back to Home</button>
        </div>
        <div class="row">
          <div>
            <label for="testName">Test name</label>
            <input id="testName" placeholder="Eg: UPSC Prelims mock, CSAT set 1" />
          </div>
          <div>
            <label for="testScore">Score (%)</label>
            <input id="testScore" type="number" min="0" max="100" />
          </div>
          <div>
            <label for="testWeek">Week tag</label>
            <input id="testWeek" placeholder="Eg: 2025-W01" />
          </div>
        </div>
        <label for="testNotes" style="margin-top:8px;">What went wrong / pattern?</label>
        <textarea id="testNotes" placeholder="Eg: Weak in history MCQs, silly mistakes in maths‚Ä¶"></textarea>
        <div class="muted" style="margin-top:4px;">We‚Äôll group tests by week so you can see patterns.</div>
        <div style="margin-top:8px;">
          <button class="secondary" id="addTestBtn">Ôºã Add Test</button>
        </div>
        <div id="testSummary" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="page-admin" style="display:none;">
      <div class="card">
        <div class="section-title">
          Admin ‚Äì Subjects & Resources
          <span class="muted">Add subjects, and upload links for each subject</span>
        </div>
        <div class="row">
          <div>
            <label for="adminPartSelect">Part / Area</label>
            <select id="adminPartSelect"></select>
          </div>
          <div>
            <label for="adminSubjectSelect">Subject</label>
            <select id="adminSubjectSelect"></select>
          </div>
        </div>
        <div class="row" style="margin-top:6px;">
          <div>
            <label for="adminNewSubject">Add new subject</label>
            <input id="adminNewSubject" placeholder="Eg: Modern History / Quant / Reasoning" />
          </div>
          <div style="flex:0 0 140px; display:flex; gap:6px; align-items:flex-end;">
            <button class="secondary" id="adminAddSubjectBtn">Ôºã Add</button>
            <button class="secondary" id="adminDeleteSubjectBtn">‚úï Delete</button>
          </div>
        </div>
        <hr style="margin:12px 0; border:none; border-top:1px solid var(--border-soft);">
        <div class="row">
          <div>
            <label for="resTitle">Resource title</label>
            <input id="resTitle" placeholder="Eg: NCERT Polity Ch1 PDF" />
            <label for="resLink" style="margin-top:6px;">Link (PDF / site / notes / video)</label>
            <input id="resLink" placeholder="Paste URL here (Drive, NCERT, notes, YouTube‚Ä¶)" />
            <button class="secondary" id="addResBtn" style="margin-top:8px;">Ôºã Add resource</button>
            <div class="muted" style="margin-top:4px;">
              Saved for the selected <strong>Part</strong> and <strong>Subject</strong>.  
              You must choose subject yourself ‚Äì app will not choose automatically.
            </div>
            <div id="adminResourceList" class="entries-list" style="margin-top:8px;"></div>
          </div>
          <div>
            <div class="muted" style="margin-bottom:4px;">Preview</div>
            <iframe id="adminResourceViewer" style="width:100%; min-height:220px;"></iframe>
            <div class="muted" style="margin-top:4px;">
              If some sites/PDFs block embedding, they may open in a new tab instead.
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          YouTube / Audio Focus (Admin)
          <span class="muted">15-min focus timer, logs under current part</span>
        </div>
        <label for="ytLink">YouTube link</label>
        <input id="ytLink" placeholder="Paste YouTube URL here (https://www.youtube.com/watch?v=...)" />
        <div class="row" style="margin-top:8px;">
          <button class="secondary" id="ytLoadBtn">üì∫ Load in app</button>
          <button class="secondary" id="ytStartTimerBtn">‚è± Start 15 min timer</button>
          <button class="secondary" id="ytStopTimerBtn">üõë Stop timer</button>
        </div>
        <div class="muted" style="margin-top:4px;">
          Timer entries will be logged under whichever part is selected in the top menu (UPSC, Career, etc).
        </div>
        <div style="margin-top:10px;">
          <iframe id="ytFrame"
                  style="width:100%; aspect-ratio:16/9;"
                  src=""
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen>
          </iframe>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          Backup & Restore
          <span class="muted">Export/Import all your data</span>
        </div>
        <div class="row">
          <button class="secondary" id="exportBtn">‚¨á Export backup</button>
          <button class="secondary" id="importBtn">‚¨Ü Import backup</button>
        </div>
        <div class="muted" style="margin-top:4px;">
          This includes logs, subjects, resources, tests, reminders and settings.
        </div>
      </div>
    </div>
  </div>

  <!-- Subject full-screen overlay -->
  <div class="overlay" id="subjectOverlay">
    <div class="overlay-card">
      <div class="section-title">
        <span id="subjectOverlayTitle">UPSC ‚Ä¢ Subject</span>
        <button class="secondary" id="subjectOverlayCloseBtn">‚úï Close</button>
      </div>
      <div class="overlay-body">
        <div>
          <div class="muted" style="margin-bottom:4px;">Resources list</div>
          <div id="subjectResourceList" class="entries-list"></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:4px;">Viewer</div>
          <iframe id="subjectResourceViewer"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const APP_VERSION = '1.3.0';

    const STORAGE_KEY = 'karu_logs_v1';
    const SUBJECT_KEY = 'karu_subjects_v1';
    const META_KEY = 'karu_meta_v1';
    const RESOURCE_KEY = 'karu_resources_v1';
    const TEST_KEY = 'karu_tests_v1';

    const defaultParts = ['UPSC','Career','Other Exams','Personal Work','Meditation'];

    const defaultSubjects = {
      'UPSC': ['Polity','Geography','Economy','History','Science','CSAT','Optional'],
      'Career': ['Job Search','Skill Development','Networking'],
      'Other Exams': ['Banking','Insurance','MBA Entrance'],
      'Personal Work': ['Health','Family','Finance','Other'],
      'Meditation': ['Breath','Om chanting','Gratitude']
    };

    let logs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let subjects = JSON.parse(localStorage.getItem(SUBJECT_KEY) || 'null') || defaultSubjects;
    let meta = JSON.parse(localStorage.getItem(META_KEY) || 'null') || {
      theme: 'light',
      reminders: {},
      reviveUsedWeek: null,
      appVersion: APP_VERSION
    };
    let resources = JSON.parse(localStorage.getItem(RESOURCE_KEY) || '[]');
    let tests = JSON.parse(localStorage.getItem(TEST_KEY) || '[]');

    let currentPart = 'UPSC';
    let chartInstance = null;
    let subjectChartInstance = null;
    let ytTimerId = null;
    let omTimerId = null;
    let overlayPart = null;
    let overlaySubject = null;

    // Elements
    const themeSelect = document.getElementById('themeSelect');
    const versionLabel = document.getElementById('versionLabel');
    const mainNav = document.getElementById('mainNav');

    const pageHome = document.getElementById('page-home');
    const pagePart = document.getElementById('page-part');
    const pageTests = document.getElementById('page-tests');
    const pageAdmin = document.getElementById('page-admin');

    const homePartLabel = document.getElementById('homePartLabel');
    const homePartLabel2 = document.getElementById('homePartLabel2');
    const partTitle = document.getElementById('partTitle');
    const partSubtitle = document.getElementById('partSubtitle');
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const backTestsHomeBtn = document.getElementById('backTestsHomeBtn');

    const subjectSelect = document.getElementById('subjectSelect');
    const partSubjectsList = document.getElementById('partSubjectsList');

    const learningInput = document.getElementById('learningInput');
    const timeInput = document.getElementById('timeInput');
    const memoryInput = document.getElementById('memoryInput');
    const reminderTime = document.getElementById('reminderTime');
    const saveEntryBtn = document.getElementById('saveEntryBtn');
    const entriesList = document.getElementById('entriesList');
    const todayBadge = document.getElementById('todayBadge');
    const entriesLabel = document.getElementById('entriesLabel');

    const currentStreakEl = document.getElementById('currentStreak');
    const bestStreakEl = document.getElementById('bestStreak');
    const reviveBtn = document.getElementById('reviveBtn');
    const chartCanvas = document.getElementById('progressChart');
    const subjectCanvas = document.getElementById('subjectChart');

    const testName = document.getElementById('testName');
    const testScore = document.getElementById('testScore');
    const testWeek = document.getElementById('testWeek');
    const testNotes = document.getElementById('testNotes');
    const testSummary = document.getElementById('testSummary');
    const addTestBtn = document.getElementById('addTestBtn');

    const aiQuestion = document.getElementById('aiQuestion');
    const aiBtn = document.getElementById('aiBtn');
    const aiResponse = document.getElementById('aiResponse');
    const aiReadBtn = document.getElementById('aiReadBtn');

    const ytLink = document.getElementById('ytLink');
    const ytLoadBtn = document.getElementById('ytLoadBtn');
    const ytStartTimerBtn = document.getElementById('ytStartTimerBtn');
    const ytStopTimerBtn = document.getElementById('ytStopTimerBtn');
    const ytFrame = document.getElementById('ytFrame');

    const adminPartSelect = document.getElementById('adminPartSelect');
    const adminSubjectSelect = document.getElementById('adminSubjectSelect');
    const adminNewSubject = document.getElementById('adminNewSubject');
    const adminAddSubjectBtn = document.getElementById('adminAddSubjectBtn');
    const adminDeleteSubjectBtn = document.getElementById('adminDeleteSubjectBtn');
    const resTitle = document.getElementById('resTitle');
    const resLink = document.getElementById('resLink');
    const addResBtn = document.getElementById('addResBtn');
    const adminResourceList = document.getElementById('adminResourceList');
    const adminResourceViewer = document.getElementById('adminResourceViewer');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');

    const subjectOverlay = document.getElementById('subjectOverlay');
    const subjectOverlayTitle = document.getElementById('subjectOverlayTitle');
    const subjectOverlayCloseBtn = document.getElementById('subjectOverlayCloseBtn');
    const subjectResourceList = document.getElementById('subjectResourceList');
    const subjectResourceViewer = document.getElementById('subjectResourceViewer');

    const omLink = document.getElementById('omLink');
    const om5Btn = document.getElementById('om5Btn');
    const om10Btn = document.getElementById('om10Btn');
    const omStopBtn = document.getElementById('omStopBtn');
    const omStatus = document.getElementById('omStatus');
    const omFrame = document.getElementById('omFrame');

    // Theme
    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      meta.theme = theme;
      localStorage.setItem(META_KEY, JSON.stringify(meta));
    }
    themeSelect.addEventListener('change', e => applyTheme(e.target.value));
    versionLabel.textContent = APP_VERSION;

    // Navigation
    function setNavActive(navName) {
      [...mainNav.querySelectorAll('button')].forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-nav') === navName);
      });
    }

    function showPage(page) {
      pageHome.style.display = (page === 'home') ? 'block' : 'none';
      pagePart.style.display = (page === 'part') ? 'block' : 'none';
      pageTests.style.display = (page === 'tests') ? 'block' : 'none';
      pageAdmin.style.display = (page === 'admin') ? 'block' : 'none';
    }

    function setCurrentPart(part) {
      currentPart = part;
      homePartLabel.textContent = part;
      homePartLabel2.textContent = part;
      entriesLabel.textContent = part;
      partTitle.textContent = part + ' workspace';
      partSubtitle.textContent = 'Choose a subject to open its full-screen resources.';
      renderSubjectsSelect();
      renderSubjectsForPart();
      renderEntries();
      renderStreak();
      renderCharts();
      reminderTime.value = meta.reminders[currentPart] || '';
      todayBadge.textContent = new Date().toLocaleDateString();
    }

    mainNav.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      const nav = e.target.getAttribute('data-nav');
      if (nav === 'home') {
        showPage('home');
        setNavActive('home');
      } else if (nav === 'tests') {
        showPage('tests');
        setNavActive('tests');
      } else if (nav === 'admin') {
        showPage('admin');
        setNavActive('admin');
        renderAdminPartOptions();
        renderAdminSubjects();
        renderAdminResources();
      } else {
        // part
        setCurrentPart(nav);
        showPage('part');
        setNavActive(nav);
      }
    });

    backToHomeBtn.addEventListener('click', () => {
      showPage('home');
      setNavActive('home');
    });
    backTestsHomeBtn.addEventListener('click', () => {
      showPage('home');
      setNavActive('home');
    });

    // Week / streak helpers
    function weekIdFromDate(date) {
      const d = new Date(date.getTime());
      d.setHours(0,0,0,0);
      const oneJan = new Date(d.getFullYear(),0,1);
      const diff = d - oneJan + ((oneJan.getTimezoneOffset() - d.getTimezoneOffset())*60000);
      const week = Math.floor(diff / (7*24*60*60*1000));
      return d.getFullYear() + '-W' + String(week+1).padStart(2,'0');
    }

    function getPartDays(part) {
      const set = new Set();
      logs.filter(l => l.part === part).forEach(l => {
        const d = new Date(l.date);
        d.setHours(0,0,0,0);
        set.add(d.getTime());
      });
      return Array.from(set).sort();
    }

    function computeStreak(part) {
      const days = getPartDays(part);
      if (!days.length) return {current:0,best:0};
      const today = new Date();
      today.setHours(0,0,0,0);
      let current = 0;
      let best = 1;
      let prevDay = null;
      days.forEach(ts => {
        const d = new Date(ts);
        if (!prevDay) {
          prevDay = d; current = 1; best = 1; return;
        }
        const diffDays = Math.round((d - prevDay) / (24*60*60*1000));
        if (diffDays === 1) current++;
        else if (diffDays > 1) current = 1;
        if (current > best) best = current;
        prevDay = d;
      });
      const lastDay = new Date(days[days.length-1]);
      const diffFromToday = Math.round((today - lastDay) / (24*60*60*1000));
      if (diffFromToday > 1) current = 0;
      return {current,best};
    }

    // Subjects
    function renderSubjectsSelect() {
      const list = subjects[currentPart] || [];
      subjectSelect.innerHTML = '';
      list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        subjectSelect.appendChild(opt);
      });
    }

    function renderSubjectsForPart() {
      const list = subjects[currentPart] || [];
      partSubjectsList.innerHTML = '';
      if (!list.length) {
        partSubjectsList.innerHTML = '<div class="muted">No subjects yet. Add them from Admin.</div>';
        return;
      }
      list.forEach(s => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = s;
        chip.addEventListener('click', () => openSubjectOverlay(currentPart, s));
        partSubjectsList.appendChild(chip);
      });
    }

    // Entries
    todayBadge.textContent = new Date().toLocaleDateString();

    saveEntryBtn.addEventListener('click', () => {
      const subject = subjectSelect.value || 'General';
      const learning = learningInput.value.trim();
      const time = Number(timeInput.value || 0);
      const memory = Number(memoryInput.value || 3);

      if (!learning) {
        alert('Write at least one line about what you learned.');
        return;
      }

      const entry = {
        id: Date.now(),
        part: currentPart,
        subject,
        learning,
        time,
        memory,
        date: new Date().toISOString()
      };
      logs.push(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));

      if (reminderTime.value) {
        meta.reminders[currentPart] = reminderTime.value;
        localStorage.setItem(META_KEY, JSON.stringify(meta));
      }

      learningInput.value = '';
      timeInput.value = '';
      reminderTime.value = meta.reminders[currentPart] || '';

      renderEntries();
      renderStreak();
      renderCharts();
      alert('Saved! Good job, Tilak.');
    });

    function renderEntries() {
      entriesList.innerHTML = '';
      const filtered = logs
        .filter(l => l.part === currentPart)
        .sort((a,b) => new Date(b.date) - new Date(a.date));
      if (!filtered.length) {
        entriesList.innerHTML = '<div class="muted">No entries yet for this part. Log today‚Äôs study to start.</div>';
        return;
      }
      filtered.forEach(e => {
        const div = document.createElement('div');
        div.className = 'entry';
        const d = new Date(e.date);
        div.innerHTML = `<small>${d.toLocaleString()} ‚Ä¢ ${e.subject}</small>
          <div>${e.learning.replace(/</g,'&lt;')}</div>
          <small>Time: ${e.time || 0} mins ‚Ä¢ Memory: ${e.memory}/5</small>`;
        entriesList.appendChild(div);
      });
    }

    function renderStreak() {
      const {current,best} = computeStreak(currentPart);
      currentStreakEl.textContent = current;
      bestStreakEl.textContent = best;
    }

    reviveBtn.addEventListener('click', () => {
      const now = new Date();
      const thisWeek = weekIdFromDate(now);
      if (meta.reviveUsedWeek === thisWeek) {
        alert('You already used revive once this week.');
        return;
      }
      const yesterday = new Date(now.getTime() - 24*60*60*1000);
      yesterday.setHours(12,0,0,0);
      const days = getPartDays(currentPart);
      const yts = yesterday.getTime();
      if (!days.includes(yts)) {
        logs.push({
          id: Date.now() + 1,
          part: currentPart,
          subject: 'Revive Day',
          learning: 'Streak revive placeholder entry.',
          time: 0,
          memory: 3,
          date: yesterday.toISOString()
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      }
      meta.reviveUsedWeek = thisWeek;
      localStorage.setItem(META_KEY, JSON.stringify(meta));
      renderStreak();
      renderEntries();
      renderCharts();
      alert('Your streak has been revived for this week!');
    });

    // Charts
    function renderCharts() {
      const now = new Date();
      const days = [];
      const totals = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now.getTime() - i*24*60*60*1000);
        d.setHours(0,0,0,0);
        days.push((d.getMonth()+1) + '/' + d.getDate());
        const dayTotal = logs
          .filter(l => l.part === currentPart && (new Date(l.date)).toDateString() === d.toDateString())
          .reduce((sum,l)=>sum+(l.time||0),0);
        totals.push(dayTotal);
      }
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(chartCanvas, {
        type: 'bar',
        data: { labels: days, datasets: [{ label: 'Minutes studied', data: totals }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const map = {};
      logs.filter(l => l.part === currentPart).forEach(l => {
        const s = l.subject || 'General';
        map[s] = (map[s] || 0) + (l.time || 0);
      });
      const labels = Object.keys(map);
      const data = labels.map(k => map[k]);
      if (subjectChartInstance) subjectChartInstance.destroy();
      subjectChartInstance = new Chart(subjectCanvas, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Minutes studied', data }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Tests
    function renderTestSummary() {
      if (!tests.length) {
        testSummary.textContent = 'No tests logged yet.';
        return;
      }
      const byWeek = {};
      tests.forEach(t => {
        byWeek[t.week] = byWeek[t.week] || [];
        byWeek[t.week].push(t);
      });
      let html = '';
      Object.keys(byWeek).sort().forEach(week => {
        const arr = byWeek[week];
        const avg = arr.reduce((s,t)=>s+(t.score||0),0)/arr.length;
        html += `<div><strong>${week}</strong>: ${arr.length} test(s), avg score ${avg.toFixed(1)}%`;
        const weak = arr.filter(t => t.score < 60);
        if (weak.length) html += ` ‚Äì Focus: ${weak.length} weak test(s)`;
        html += '</div>';
      });
      testSummary.innerHTML = html;
    }

    addTestBtn.addEventListener('click', () => {
      const name = testName.value.trim();
      const score = Number(testScore.value || 0);
      const week = testWeek.value.trim() || weekIdFromDate(new Date());
      const notes = testNotes.value.trim();
      if (!name) { alert('Enter test name.'); return; }
      const t = { id: Date.now(), name, score, week, notes };
      tests.push(t);
      localStorage.setItem(TEST_KEY, JSON.stringify(tests));
      testName.value = '';
      testScore.value = '';
      testWeek.value = '';
      testNotes.value = '';
      renderTestSummary();
      alert('Test saved.');
    });

    // AI helper
    function aiReply(q) {
      const text = q.toLowerCase();
      if (!text.trim()) return 'Type a question about your study, habits, or planning.';
      if (text.includes('history')) return 'For history with weak memory: (1) Use story-based videos first, then read a small section of Spectrum; (2) Make timeline notes with arrows instead of paragraphs; (3) Revise the same topic after 1 day, 3 days, and 7 days; (4) Practice 5 MCQs after each topic so your brain is forced to recall.';
      if (text.includes('math') || text.includes('aptitude') || text.includes('csat')) return 'For maths/CSAT: (1) Focus only on basics: percentages, ratios, averages, and simple equations; (2) Do 10 questions a day, not 100 ‚Äì small daily practice wins; (3) Mark questions you got wrong in a ‚Äúmistake notebook‚Äù and redo them after 3 days; (4) In exam, attempt all comprehension questions first because they carry high marks even without strong maths.';
      if (text.includes('science')) return 'For science: (1) Limit yourself to NCERT 6‚Äì10 diagrams and key boxes; (2) Focus on human body, diseases, nutrition, environment, and basic physics terms used in daily life; (3) Make tiny flashcards ‚Äì one side term, other side meaning; (4) Connect every concept to a real-life example (e.g., lens ‚Üí spectacles, friction ‚Üí walking).';
      if (text.includes('upsc') || text.includes('study plan') || text.includes('timetable')) return 'For UPSC with 1.5‚Äì2 hours a day: (1) 30 min concept video, (2) 40 min reading + short notes of same topic, (3) 10‚Äì15 min revision of yesterday, (4) If energy left, 5‚Äì10 MCQs. Protect your streak more than your total hours ‚Äì consistency is your real power.';
      if (text.includes('motivate') || text.includes('demotivate') || text.includes('tired')) return 'When you feel demotivated: (1) Do the smallest possible task ‚Äì watch a 5-minute video or read half a page; (2) Mark it as done here so your streak continues; (3) Re-read your reasons for preparing UPSC; (4) Remember: even 20 minutes done with focus is better than a full day of regret.';
      return 'Tip: Break your problem into tiny steps. Pick one topic, set a 25-minute timer, do only that, then log it here. If you tell me which subject or problem you are facing (history, maths, schedule, memory, etc.), I can give you a more specific micro-plan.';
    }

    aiBtn.addEventListener('click', () => {
      const ans = aiReply(aiQuestion.value || '');
      aiResponse.textContent = ans;
    });

    function speakTextInIndianEnglish(text) {
      if (!('speechSynthesis' in window)) {
        alert('Text-to-speech is not supported in this browser.');
        return;
      }
      if (!text.trim()) {
        alert('No answer to read yet.');
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      function pickVoiceAndSpeak() {
        const voices = speechSynthesis.getVoices();
        const indian = voices.find(v => v.lang === 'en-IN');
        const english = voices.find(v => v.lang.startsWith('en')) || null;
        if (indian) utter.voice = indian;
        else if (english) utter.voice = english;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }
      const voices = speechSynthesis.getVoices();
      if (!voices.length) {
        speechSynthesis.onvoiceschanged = pickVoiceAndSpeak;
      } else {
        pickVoiceAndSpeak();
      }
    }
    aiReadBtn.addEventListener('click', () => {
      speakTextInIndianEnglish(aiResponse.textContent || '');
    });

    // Admin: parts & subjects
    function renderAdminPartOptions() {
      adminPartSelect.innerHTML = '';
      defaultParts.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        adminPartSelect.appendChild(opt);
      });
      adminPartSelect.value = currentPart;
    }

    function renderAdminSubjects() {
      const part = adminPartSelect.value;
      const list = subjects[part] || [];
      adminSubjectSelect.innerHTML = '';
      list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        adminSubjectSelect.appendChild(opt);
      });
    }

    adminPartSelect.addEventListener('change', () => {
      renderAdminSubjects();
      renderAdminResources();
    });
    adminSubjectSelect.addEventListener('change', renderAdminResources);

    adminAddSubjectBtn.addEventListener('click', () => {
      const part = adminPartSelect.value;
      const name = adminNewSubject.value.trim();
      if (!name) return;
      subjects[part] = subjects[part] || [];
      if (!subjects[part].includes(name)) {
        subjects[part].push(name);
        localStorage.setItem(SUBJECT_KEY, JSON.stringify(subjects));
        adminNewSubject.value = '';
        renderAdminSubjects();
        if (part === currentPart) {
          renderSubjectsSelect();
          renderSubjectsForPart();
        }
        alert('Subject added.');
      } else {
        alert('Subject already exists.');
      }
    });

    adminDeleteSubjectBtn.addEventListener('click', () => {
      const part = adminPartSelect.value;
      const subj = adminSubjectSelect.value;
      if (!subj) { alert('No subject selected.'); return; }
      if (!confirm(`Delete subject "${subj}" from ${part}? Resources remain but will be unattached.`)) return;
      subjects[part] = (subjects[part] || []).filter(s => s !== subj);
      localStorage.setItem(SUBJECT_KEY, JSON.stringify(subjects));
      renderAdminSubjects();
      if (part === currentPart) {
        renderSubjectsSelect();
        renderSubjectsForPart();
      }
    });

    // Admin resources
    function renderAdminResources() {
      const part = adminPartSelect.value;
      const subj = adminSubjectSelect.value;
      adminResourceList.innerHTML = '';
      adminResourceViewer.src = '';
      if (!part || !subj) {
        adminResourceList.innerHTML = '<div class="muted">Select part and subject first.</div>';
        return;
      }
      const filtered = resources
        .filter(r => r.part === part && r.subject === subj)
        .sort((a,b) => new Date(b.date) - new Date(a.date));
      if (!filtered.length) {
        adminResourceList.innerHTML = '<div class="muted">No resources yet for this subject.</div>';
        return;
      }
      filtered.forEach(r => {
        const d = new Date(r.date);
        const div = document.createElement('div');
        div.className = 'entry clickable small-padding';
        div.innerHTML = `
          <small>${d.toLocaleString()}</small>
          <div style="font-weight:600; margin-bottom:2px;">${r.title || 'Resource'}</div>
          <div style="word-break:break-all; font-size:0.78rem;">${r.link}</div>
        `;
        div.addEventListener('click', () => {
          try { adminResourceViewer.src = r.link; }
          catch (e) { window.open(r.link, '_blank'); }
        });
        adminResourceList.appendChild(div);
      });
    }

    addResBtn.addEventListener('click', () => {
      const part = adminPartSelect.value;
      const subj = adminSubjectSelect.value;
      if (!part || !subj) {
        alert('Select part and subject first. The app will not choose subject automatically.');
        return;
      }
      const title = (resTitle.value || '').trim() || 'Resource';
      const link = (resLink.value || '').trim();
      if (!link) {
        alert('Paste a link first.');
        return;
      }
      const now = new Date();
      const res = {
        id: Date.now(),
        part,
        subject: subj,
        title,
        link,
        date: now.toISOString()
      };
      resources.push(res);
      localStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));
      resTitle.value = '';
      resLink.value = '';
      renderAdminResources();
      alert('Resource saved.');
    });

    // Subject overlay (view-only resources for that subject)
    function renderSubjectResources() {
      subjectResourceList.innerHTML = '';
      subjectResourceViewer.src = '';
      if (!overlayPart || !overlaySubject) {
        subjectResourceList.innerHTML = '<div class="muted">No subject selected.</div>';
        return;
      }
      const filtered = resources
        .filter(r => r.part === overlayPart && r.subject === overlaySubject)
        .sort((a,b) => new Date(b.date) - new Date(a.date));
      if (!filtered.length) {
        subjectResourceList.innerHTML = '<div class="muted">No resources saved yet. Add them from Admin.</div>';
        return;
      }
      filtered.forEach(r => {
        const d = new Date(r.date);
        const div = document.createElement('div');
        div.className = 'entry clickable small-padding';
        div.innerHTML = `
          <small>${d.toLocaleString()}</small>
          <div style="font-weight:600; margin-bottom:2px;">${r.title || 'Resource'}</div>
          <div style="word-break:break-all; font-size:0.78rem;">${r.link}</div>
        `;
        div.addEventListener('click', () => {
          try { subjectResourceViewer.src = r.link; }
          catch (e) { window.open(r.link, '_blank'); }
        });
        subjectResourceList.appendChild(div);
      });
    }

    function openSubjectOverlay(part, subj) {
      overlayPart = part;
      overlaySubject = subj;
      subjectOverlayTitle.textContent = part + ' ‚Ä¢ ' + subj;
      subjectOverlay.style.display = 'flex';
      renderSubjectResources();
    }

    subjectOverlayCloseBtn.addEventListener('click', () => {
      subjectOverlay.style.display = 'none';
      subjectResourceViewer.src = '';
    });
    subjectOverlay.addEventListener('click', e => {
      if (e.target === subjectOverlay) {
        subjectOverlay.style.display = 'none';
        subjectResourceViewer.src = '';
      }
    });

    // YouTube focus (Admin) ‚Äì logs entry only, does NOT auto-add resources
    function getEmbedUrlFromYoutubeLink(url) {
      if (!url) return null;
      url = url.trim();
      if (url.includes('youtu.be/')) {
        const id = url.split('youtu.be/')[1].split(/[?&]/)[0];
        return 'https://www.youtube.com/embed/' + id;
      }
      try {
        const u = new URL(url);
        const v = u.searchParams.get('v');
        if (v) return 'https://www.youtube.com/embed/' + v;
      } catch(e) {}
      return null;
    }

    ytLoadBtn.addEventListener('click', () => {
      const raw = ytLink.value;
      const embed = getEmbedUrlFromYoutubeLink(raw);
      if (!embed) {
        alert('Please paste a valid YouTube link.');
        return;
      }
      ytFrame.src = embed;
    });

    function onYtTimerComplete() {
      ytTimerId = null;
      alert('15 minutes completed ‚Äì time to review what you watched or take a short break.');
      const link = (ytLink.value || '').trim();
      const subject = 'YouTube / Audio';
      const now = new Date();
      const entry = {
        id: Date.now(),
        part: currentPart,
        subject,
        learning: link ? ('Watched/listened: ' + link) : '15-minute focus session',
        time: 15,
        memory: 3,
        date: now.toISOString()
      };
      logs.push(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      renderEntries();
      renderStreak();
      renderCharts();
    }

    function startYtTimer() {
      if (ytTimerId) {
        clearTimeout(ytTimerId);
        ytTimerId = null;
      }
      ytTimerId = setTimeout(onYtTimerComplete, 15 * 60 * 1000);
      alert('15-minute timer started.');
    }
    function stopYtTimer() {
      if (ytTimerId) {
        clearTimeout(ytTimerId);
        ytTimerId = null;
        alert('Timer stopped.');
      } else {
        alert('No active timer.');
      }
    }
    ytStartTimerBtn.addEventListener('click', startYtTimer);
    ytStopTimerBtn.addEventListener('click', stopYtTimer);

    // Export / Import (Admin only)
    exportBtn.addEventListener('click', () => {
      const data = { logs, subjects, meta, tests, resources };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'karunamaayi_backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      alert('Backup exported as JSON.');
    });

    importBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const data = JSON.parse(ev.target.result);
            logs = data.logs || [];
            subjects = data.subjects || subjects;
            meta = data.meta || meta;
            tests = data.tests || tests;
            resources = data.resources || resources;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            localStorage.setItem(SUBJECT_KEY, JSON.stringify(subjects));
            localStorage.setItem(META_KEY, JSON.stringify(meta));
            localStorage.setItem(TEST_KEY, JSON.stringify(tests));
            localStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));
            applyTheme(meta.theme || 'light');
            themeSelect.value = meta.theme || 'light';
            renderSubjectsSelect();
            renderSubjectsForPart();
            renderEntries();
            renderStreak();
            renderCharts();
            renderTestSummary();
            renderAdminPartOptions();
            renderAdminSubjects();
            renderAdminResources();
            alert('Backup imported successfully.');
          } catch (err) {
            console.error(err);
            alert('Could not import file. Make sure it is a valid backup JSON.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    // Om meditation via YouTube link
    function startOm(minutes) {
      stopOm();
      const raw = omLink.value.trim();
      const embed = getEmbedUrlFromYoutubeLink(raw);
      if (!embed) {
        alert('Paste a valid Om chanting YouTube link first.');
        return;
      }
      omFrame.src = embed;
      omStatus.textContent = `Playing Om for ${minutes} minutes...`;
      omTimerId = setTimeout(() => {
        stopOm();
        alert(`${minutes} minutes of Om meditation completed.`);
      }, minutes * 60 * 1000);
    }

    function stopOm() {
      if (omTimerId) {
        clearTimeout(omTimerId);
        omTimerId = null;
      }
      omFrame.src = '';
      omStatus.textContent = 'Not playing.';
    }

    om5Btn.addEventListener('click', () => startOm(5));
    om10Btn.addEventListener('click', () => startOm(10));
    omStopBtn.addEventListener('click', () => stopOm());

    // Reminders
    function checkReminders() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const currentTime = hh + ':' + mm;
      for (const part of defaultParts) {
        if (meta.reminders[part] === currentTime) {
          alert(`Reminder: It is time for your ${part} session.`);
        }
      }
    }
    setInterval(checkReminders, 60 * 1000);

    // Init
    function init() {
      applyTheme(meta.theme || 'light');
      themeSelect.value = meta.theme || 'light';
      renderTestSummary();
      setCurrentPart('UPSC');
      renderAdminPartOptions();
      renderAdminSubjects();
      renderAdminResources();
      showPage('home');
      setNavActive('home');
    }

    init();
  </script>
</body>
</html>
